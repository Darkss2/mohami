<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø®Ø¯Ù…Ø§ØªÙ†Ø§ | Nabra Dziriya</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: { brand: { primary: '#1e3a8a', gold: '#fbbf24', dark: '#0f172a' } }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-sans">

    <!-- Navbar -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2">
                <div class="w-10 h-10 bg-brand-gold rounded-lg flex items-center justify-center text-white font-bold"><i class="fa-solid fa-scale-balanced"></i></div>
                <h1 class="text-xl font-bold text-brand-primary">Ù†Ø¨Ø±Ø© Ø¬Ø²Ø§Ø¦Ø±ÙŠØ©</h1>
            </a>
            <div class="flex items-center gap-4">
                <a href="index.html" class="text-gray-600 hover:text-brand-primary font-bold">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                <button onclick="toggleCart()" class="relative p-2 text-brand-primary text-xl">
                    <i class="fa-solid fa-cart-shopping"></i>
                    <span id="cart-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full opacity-0 transition">0</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="bg-brand-primary text-white py-16 text-center">
        <h1 class="text-4xl font-bold mb-4">Ø®Ø¯Ù…Ø§ØªÙ†Ø§ ÙˆÙ…Ù†ØªØ¬Ø§ØªÙ†Ø§</h1>
        <p class="text-blue-200 text-lg">Ø§Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø§ØªÙƒ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø¨ÙƒÙ„ Ø³Ù‡ÙˆÙ„Ø©</p>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-12 flex flex-col lg:flex-row gap-8">
        
        <!-- Sidebar Filters -->
        <aside class="lg:w-1/4">
            <div class="bg-white p-6 rounded-2xl shadow-sm sticky top-24">
                <h3 class="font-bold text-xl mb-4 text-brand-dark">Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h3>
                <ul id="category-list" class="space-y-2">
                    <li><button onclick="filterProducts('all')" class="w-full text-right px-4 py-2 rounded-lg bg-blue-50 text-brand-primary font-bold">Ø§Ù„ÙƒÙ„</button></li>
                    <!-- Dynamic Categories -->
                </ul>
            </div>
        </aside>

        <!-- Product Grid -->
        <div class="lg:w-3/4">
            <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Products Injected Here -->
                <div class="col-span-full text-center py-20 text-gray-400">
                    <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-4"></i>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Cart Sidebar -->
    <div id="cart-sidebar" class="fixed inset-y-0 left-0 w-full md:w-96 bg-white shadow-2xl transform -translate-x-full transition duration-300 z-[60] flex flex-col">
        <div class="p-5 border-b flex justify-between items-center bg-brand-dark text-white">
            <h2 class="font-bold text-xl"><i class="fa-solid fa-receipt ml-2"></i> Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
            <button onclick="toggleCart()" class="hover:text-red-400"><i class="fa-solid fa-xmark text-2xl"></i></button>
        </div>
        <div id="cart-items" class="flex-1 overflow-y-auto p-5 space-y-4">
            <!-- Cart Items -->
            <p class="text-center text-gray-400 mt-10">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p>
        </div>
        <div class="p-5 border-t bg-gray-50">
            <div class="flex justify-between font-bold text-xl mb-4 text-brand-dark">
                <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
                <span id="cart-total">0 Ø¯.Ø¬</span>
            </div>
            <button onclick="openCheckout()" class="w-full bg-brand-gold hover:bg-yellow-500 text-brand-dark font-bold py-4 rounded-xl transition shadow-lg">
                Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
            </button>
        </div>
    </div>
    
    <!-- Overlay -->
    <div id="overlay" onclick="toggleCart()" class="fixed inset-0 bg-black/50 z-[55] hidden backdrop-blur-sm"></div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-float">
            <div class="bg-brand-primary p-6 text-white flex justify-between items-center">
                <h3 class="font-bold text-xl">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</h3>
                <button onclick="closeCheckout()" class="hover:text-red-300"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form id="checkout-form" onsubmit="processOrder(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" name="name" required class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-brand-gold outline-none">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="tel" name="phone" required class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-brand-gold outline-none">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† / Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</label>
                    <input type="text" name="address" required class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-brand-gold outline-none">
                </div>
                
                <div id="order-summary" class="bg-gray-50 p-3 rounded-lg text-sm text-gray-600"></div>

                <button type="submit" id="confirm-btn" class="w-full bg-brand-primary text-white font-bold py-3 rounded-xl hover:bg-brand-dark transition">
                    ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„
                </button>
            </form>
        </div>
    </div>

    <script>
        let products = [];
        let cart = [];
        let settings = {};

        // Load Data
        Promise.all([
            fetch('/content/products.json').then(r => r.json()),
            fetch('/content/settings.json').then(r => r.json())
        ]).then(([prodData, setData]) => {
            products = prodData.items;
            settings = setData;
            renderProducts(products);
            renderCategories();
        });

        function renderCategories() {
            const categories = [...new Set(products.map(p => p.category))];
            const container = document.getElementById('category-list');
            categories.forEach(cat => {
                container.innerHTML += `<li><button onclick="filterProducts('${cat}')" class="w-full text-right px-4 py-2 rounded-lg hover:bg-gray-100 text-gray-600 transition">${cat}</button></li>`;
            });
        }

        function filterProducts(cat) {
            const filtered = cat === 'all' ? products : products.filter(p => p.category === cat);
            renderProducts(filtered);
        }

        function renderProducts(items) {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = items.map(p => `
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-xl transition duration-300 flex flex-col h-full group">
                    <div class="h-48 overflow-hidden relative">
                        <img src="${p.image}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                        <span class="absolute top-4 right-4 bg-brand-gold text-brand-dark text-xs font-bold px-3 py-1 rounded-full">${p.category}</span>
                    </div>
                    <div class="p-6 flex-1 flex flex-col">
                        <h3 class="font-bold text-xl text-brand-dark mb-2">${p.title}</h3>
                        <p class="text-gray-500 text-sm mb-4 flex-1">${p.description}</p>
                        <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-50">
                            <span class="text-brand-primary font-black text-xl">${p.price} Ø¯.Ø¬</span>
                            <button onclick="addToCart('${p.id}')" class="bg-brand-dark text-white w-10 h-10 rounded-lg flex items-center justify-center hover:bg-brand-gold hover:text-brand-dark transition">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Cart Logic
        function addToCart(id) {
            const product = products.find(p => p.id === id);
            cart.push(product);
            updateCartUI();
            toggleCart(true); // Open cart
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartUI();
        }

        function updateCartUI() {
            document.getElementById('cart-badge').innerText = cart.length;
            document.getElementById('cart-badge').style.opacity = cart.length > 0 ? 1 : 0;
            
            const total = cart.reduce((sum, item) => sum + item.price, 0);
            document.getElementById('cart-total').innerText = total + " Ø¯.Ø¬";
            
            const container = document.getElementById('cart-items');
            if (cart.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 mt-10">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p>';
            } else {
                container.innerHTML = cart.map((item, idx) => `
                    <div class="flex gap-4 items-center bg-gray-50 p-3 rounded-xl animate-float">
                        <img src="${item.image}" class="w-12 h-12 rounded-lg object-cover">
                        <div class="flex-1">
                            <h4 class="font-bold text-sm text-brand-dark">${item.title}</h4>
                            <span class="text-brand-primary text-xs font-bold">${item.price} Ø¯.Ø¬</span>
                        </div>
                        <button onclick="removeFromCart(${idx})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `).join('');
            }
        }

        function toggleCart(forceOpen = false) {
            const sb = document.getElementById('cart-sidebar');
            const ov = document.getElementById('overlay');
            const isOpen = !sb.classList.contains('-translate-x-full');
            
            if (isOpen && !forceOpen) {
                sb.classList.add('-translate-x-full');
                ov.classList.add('hidden');
            } else {
                sb.classList.remove('-translate-x-full');
                ov.classList.remove('hidden');
            }
        }

        // Checkout Logic
        function openCheckout() {
            if(cart.length === 0) return alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!');
            toggleCart(); // Close sidebar
            document.getElementById('checkout-modal').classList.remove('hidden');
            
            // Show summary
            const total = cart.reduce((sum, item) => sum + item.price, 0);
            document.getElementById('order-summary').innerHTML = `
                Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª: <strong>${cart.length}</strong><br>
                Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong>${total} Ø¯.Ø¬</strong>
            `;
        }

        function closeCheckout() {
            document.getElementById('checkout-modal').classList.add('hidden');
        }

        async function processOrder(e) {
            e.preventDefault();
            const btn = document.getElementById('confirm-btn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
            btn.disabled = true;

            const formData = new FormData(e.target);
            const orderData = {
                customer: {
                    name: formData.get('name'),
                    phone: formData.get('phone'),
                    address: formData.get('address')
                },
                items: cart.map(c => c.title),
                total: cart.reduce((sum, i) => sum + i.price, 0),
                date: new Date().toISOString()
            };

            // CHECK SETTINGS FOR MODE
            const mode = settings.order_mode || 'formspree';

            if (mode === 'whatsapp') {
                // WhatsApp Mode
                const phone = settings.whatsapp_number.replace('+', '');
                let msg = `*Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹*%0a`;
                msg += `ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${orderData.customer.name}%0a`;
                msg += `ğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: ${orderData.customer.phone}%0a`;
                msg += `ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${orderData.customer.address}%0a`;
                msg += `------------------%0a`;
                cart.forEach(c => { msg += `â–ªï¸ ${c.title} (${c.price} Ø¯.Ø¬)%0a`; });
                msg += `------------------%0a`;
                msg += `ğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: *${orderData.total} Ø¯.Ø¬*`;
                
                window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
                finishOrder(true);

            } else if (mode === 'delivery_api') {
                // API Mode (Simulation for Yalidine/Echylia)
                try {
                    // NOTE: In a real static site, you cannot hide API keys. 
                    // This fetch would typically go to a Netlify Function.
                    // We simulate the call here.
                    console.log("Sending to API endpoint:", settings.api_config.api_url);
                    console.log("With Key:", settings.api_config.api_key);
                    
                    // Simulate network delay
                    await new Promise(r => setTimeout(r, 2000));
                    
                    // Mock Success
                    finishOrder(true, "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!");
                } catch (err) {
                    finishOrder(false, "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØµÙŠÙ„");
                }

            } else {
                // Formspree Mode (Default)
                try {
                    const response = await fetch(settings.formspree_url, {
                        method: 'POST',
                        body: JSON.stringify(orderData),
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (response.ok) finishOrder(true);
                    else finishOrder(false);
                } catch {
                    finishOrder(false);
                }
            }
        }

        function finishOrder(success, message) {
            const btn = document.getElementById('confirm-btn');
            if (success) {
                btn.className = "w-full bg-green-500 text-white font-bold py-3 rounded-xl";
                btn.innerHTML = `<i class="fa-solid fa-check"></i> ${message || 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!'}`;
                cart = [];
                updateCartUI();
                setTimeout(() => {
                    closeCheckout();
                    btn.className = "w-full bg-brand-primary text-white font-bold py-3 rounded-xl";
                    btn.innerText = "ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„";
                    btn.disabled = false;
                    document.getElementById('checkout-form').reset();
                }, 3000);
            } else {
                btn.className = "w-full bg-red-500 text-white font-bold py-3 rounded-xl";
                btn.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹`;
                setTimeout(() => {
                    btn.disabled = false;
                    btn.className = "w-full bg-brand-primary text-white font-bold py-3 rounded-xl";
                    btn.innerText = "ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„";
                }, 3000);
            }
        }
    </script>
</body>
</html>
